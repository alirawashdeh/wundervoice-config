<!doctype html>
<html>
  <head>
    <title>Authenticate with Wunderlist</title>
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
    <style type="text/css">
      #login, #loggedin {
        display: none;
      }
      .text-overflow {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        width: 500px;
      }
    </style>
  </head>

  <body>
    <div class="container">

      <div id="login">
        <h1>Authenticate with Wunderlist to use this app</h1>
        <a href="/login" class="btn btn-primary">Log in with Wunderlist</a>
      </div>

      <div id="loggedin">
        <h1>Thank you for authenticating with Wunderlist</h1>
        <button class="btn btn-primary" id="finish">Finish</button>
      </div>


    </div>

    <script src="https://code.jquery.com/jquery-1.10.1.min.js"></script>
    <script>
      (function() {

        /**
         * Obtains parameters from the hash of the URL
         * @return Object
         */
        function getHashParams() {
          var hashParams = {};
          var e, r = /([^&;=]+)=?([^&;]*)/g,
              q = window.location.hash.substring(1);
          while ( e = r.exec(q)) {
             hashParams[e[1]] = decodeURIComponent(e[2]);
          }
          return hashParams;
        }

        var params = getHashParams();

        var access_token = params.access_token,
            refresh_token = params.refresh_token,
            client_id = params.client_id,
            error = params.error;

        if (error) {
          alert('There was an error during the authentication');
        } else {
          if (access_token) {
            $('#login').hide();
            $('#loggedin').show();

            var header        = { "X-Access-Token": access_token, "X-Client-ID": client_id, contentType: "application/json;" };
            $.ajax(
          		{
          			url:     "https://a.wunderlist.com/api/v1/lists",
          			type:    "json",
          			method:  "get",
          			headers: header,
          			cache:   false
          		},
          		function( data )
          		{
          			try
          			{
          				//displayTasks( id, list, data );
              			console.log( "Success getting lists " + JSON.stringify( data ) );
          				if( typeof callback !== "undefined" ) callback();
          			}
          			catch( err )
          			{
          				reportError( "Getting Tasks: " + err.message );
          			}
          		},
          		function( err )
          		{
          			console.log( "Getting Tasks Failed: " + JSON.stringify( err ) );
          		});

          } else {
              // render initial screen
              $('#login').show();
              $('#loggedin').hide();
          }

          function getQueryParam(variable, defaultValue) {
            var query = location.search.substring(1);
            var vars = query.split('&');
            for (var i = 0; i < vars.length; i++) {
              var pair = vars[i].split('=');
              if (pair[0] === variable) {
                return decodeURIComponent(pair[1]);
              }
            }
            return defaultValue || false;
          }

          document.getElementById('finish').addEventListener('click', function() {

            var config = {
              'access_token': params.access_token,
              'client_id': params.client_id
            };

            var return_to = getQueryParam('return_to', 'pebblejs://close#');
            //return_to = decodeURIComponent('http%3A%2F%2Flocalhost%3A57661%2Fclose%3F');
            document.location = return_to + encodeURIComponent(JSON.stringify(config));
        })
      }
      })();
    </script>
</html>
